name: Claude Auto-Fix Unity Errors

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°
on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’æœ‰åŠ¹åŒ–
    inputs:
      fix_type:
        description: 'ä¿®æ­£ã®ç¨®é¡'
        required: true
        default: 'emergency'
        type: choice
        options:
        - emergency      # ç·Šæ€¥ä¿®æ­£ï¼ˆMissingReferenceExceptionï¼‰
        - data_sync      # ãƒ‡ãƒ¼ã‚¿åŒæœŸä¿®æ­£
        - comprehensive  # åŒ…æ‹¬çš„ä¿®æ­£

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Emergency Fix - MissingReferenceException
        if: ${{ github.event.inputs.fix_type == 'emergency' }}
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            ğŸ”¥ ç·Šæ€¥ä¿®æ­£: Unity MissingReferenceException ã‚¨ãƒ©ãƒ¼ã®è§£æ±º
            
            ã‚¿ã‚¹ã‚¯:
            1. Assets/Scripts/Upgrade/UpgradeSidePanelUI.cs ã® ItemActivationEffect ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¿®æ­£
            2. nullå‚ç…§ã‚¨ãƒ©ãƒ¼ã®å®Œå…¨ãªé˜²æ­¢
            3. ã‚³ãƒ«ãƒ¼ãƒãƒ³ã®å®‰å…¨æ€§å‘ä¸Š
            4. UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†
            
            ä¿®æ­£ã®ãƒã‚¤ãƒ³ãƒˆ:
            - å„ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã®å³å¯†ãªnullãƒã‚§ãƒƒã‚¯
            - try-catch ã«ã‚ˆã‚‹ä¾‹å¤–å‡¦ç†
            - MissingReferenceException ã®å°‚ç”¨ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            - gameObject.activeInHierarchy ã®ãƒã‚§ãƒƒã‚¯
            
            ä¿®æ­£å¾Œã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            
          allowed_tools: "Bash(git:*),View,GlobTool,GrepTool,BatchTool,Write"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout_minutes: "15"

      - name: Data Sync Fix
        if: ${{ github.event.inputs.fix_type == 'data_sync' }}
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            ğŸ”„ ãƒ‡ãƒ¼ã‚¿åŒæœŸä¿®æ­£: UpgradeManager ã®ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§å•é¡Œã®è§£æ±º
            
            ã‚¿ã‚¹ã‚¯:
            1. activeUpgrades ã¨ allUpgrades ã®åŒæœŸå•é¡Œã‚’ä¿®æ­£
            2. æ–°è¦ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ã®æ”¹å–„
            3. ApplyUpgrade ãƒ¡ã‚½ãƒƒãƒ‰ã®å®‰å…¨æ€§å‘ä¸Š
            4. SyncUpgradeData ãƒ¡ã‚½ãƒƒãƒ‰ã®å¼·åŒ–
            
            ä¿®æ­£ã®ãƒã‚¤ãƒ³ãƒˆ:
            - ãƒ‡ãƒ¼ã‚¿ã®ä¸€è²«æ€§ä¿è¨¼
            - æ–°è¦ã‚²ãƒ¼ãƒ æ™‚ã®å®Œå…¨ãªãƒªã‚»ãƒƒãƒˆ
            - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è¿½åŠ 
            - ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®å……å®Ÿ
            
            ä¿®æ­£å¾Œã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            
          allowed_tools: "Bash(git:*),View,GlobTool,GrepTool,BatchTool,Write"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout_minutes: "20"

      - name: Comprehensive Fix
        if: ${{ github.event.inputs.fix_type == 'comprehensive' }}
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            ğŸš€ åŒ…æ‹¬çš„ä¿®æ­£: Unity ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å®‰å…¨æ€§å‘ä¸Š
            
            ã‚¿ã‚¹ã‚¯:
            1. å…¨ã¦ã® C# ãƒ•ã‚¡ã‚¤ãƒ«ã®å®‰å…¨æ€§å‘ä¸Š
            2. nullå‚ç…§ã‚¨ãƒ©ãƒ¼ã®å®Œå…¨é˜²æ­¢
            3. ä¾‹å¤–å‡¦ç†ã®æ¨™æº–åŒ–
            4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
            5. ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§å‘ä¸Š
            
            å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«:
            - Assets/Scripts/Upgrade/UpgradeManager.cs
            - Assets/Scripts/Upgrade/UpgradeSidePanelUI.cs
            - Assets/Scripts/Upgrade/UpgradeUIManager.cs
            - Assets/Scripts/Upgrade/UpgradeSelectionUI.cs
            
            ä¿®æ­£ã®ãƒã‚¤ãƒ³ãƒˆ:
            - å…¨ãƒ¡ã‚½ãƒƒãƒ‰ã¸ã®try-catchè¿½åŠ 
            - nullãƒã‚§ãƒƒã‚¯ã®å¾¹åº•
            - ã‚³ãƒ«ãƒ¼ãƒãƒ³ã®å®‰å…¨æ€§å‘ä¸Š
            - ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®å……å®Ÿ
            - Unity ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®é©ç”¨
            
            ä¿®æ­£å¾Œã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            
          allowed_tools: "Bash(git:*),View,GlobTool,GrepTool,BatchTool,Write"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout_minutes: "30"

      - name: Create Summary Comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const runId = context.runId;
            const fixType = '${{ github.event.inputs.fix_type }}';
            
            const summary = `
            ## ğŸ¤– Claude Auto-Fix å®Ÿè¡Œå®Œäº†
            
            **ä¿®æ­£ã‚¿ã‚¤ãƒ—**: ${fixType}
            **å®Ÿè¡Œæ™‚åˆ»**: ${new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})}
            **Run ID**: ${runId}
            
            **ä¿®æ­£å†…å®¹**:
            ${fixType === 'emergency' ? '- MissingReferenceException ã®ç·Šæ€¥ä¿®æ­£' : ''}
            ${fixType === 'data_sync' ? '- ãƒ‡ãƒ¼ã‚¿åŒæœŸå•é¡Œã®ä¿®æ­£' : ''}
            ${fixType === 'comprehensive' ? '- åŒ…æ‹¬çš„ãªå®‰å…¨æ€§å‘ä¸Š' : ''}
            
            è©³ç´°ã¯ [Actions ãƒšãƒ¼ã‚¸](https://github.com/${owner}/${repo}/actions/runs/${runId}) ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
            `;
            
            // æ—¢å­˜ã®issueãŒã‚ã‚Œã°ã€ãã“ã«ã‚³ãƒ¡ãƒ³ãƒˆã€‚ãªã‘ã‚Œã°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ­ã‚°ã«è¨˜éŒ²
            console.log(summary);
